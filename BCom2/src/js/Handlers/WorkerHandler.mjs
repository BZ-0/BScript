// @ts-nocheck
"use strict"

//
import { _LOG_ } from "../Library/Symbols.mjs"
import MessageHandler from "../Protocol/MessageHandler.mjs"
import ResponseReceiver from "../Response/Receiver.mjs"
import ResponseTransmitter from "../Response/Transmitter.mjs"

//
import MessageCoderWorker from "../MessageCoder/MessageCoderWorker.mjs"
import MessageCoderAtomic from "../MessageCoder/MessageCoderAtomic.mjs"
import BaseHandler, { WrapHandle } from "./BaseHandler.mjs"
import { wrapFunc } from "../Reflection/DirectReflection.mjs"
import SyncPromise from "../Library/SyncPromise.mjs"

//
import STD from "../Library/Standard.mjs"

//
export default class WorkerHandler extends BaseHandler {
    $worker = null

    /**
     * Make object are access into object or class
     * @param {Worker} $worker WebWorker object
     * @param {Object} $options options of worker handler
     * @return {WorkerHandler} Worker handler and wrapper
     */
    constructor($worker, $options = {}) {
        super($worker, $options)

        //
        this.$outbox = [
            // synchronous
            new MessageCoderAtomic({
                $detector: this.$detector,
                $dictionary: this.$dictionary,
                $requestReflect: this.$requestReflect,
                $indirectReflect: this.$indirectReflect,
                $promiseReflect: this.$promiseReflect,
                $encode: $options.encode,
                $decode: $options.decode,
                $handler: this
            }),

            // asynchronous
            new MessageCoderWorker({
                $detector: this.$detector,
                $dictionary: this.$dictionary,
                $requestReflect: this.$requestReflect,
                $indirectReflect: this.$indirectReflect,
                $promiseReflect: this.$promiseReflect,
                $encode: $options.encode,
                $decode: $options.decode,
                $handler: this
            })
        ]

        //
        this.$inbox = new MessageCoderWorker({
            $detector: this.$detector,
            $dictionary: this.$dictionary,
            $requestReflect: this.$requestReflect,
            $indirectReflect: this.$indirectReflect,
            $promiseReflect: this.$promiseReflect,
            $encode: $options.encode,
            $decode: $options.decode,
            $handler: this
        })

        //
        this.$messageHandler = new MessageHandler(this.$responseReceivers, this.$responseTransmitters, this.$outbox[1], this.$dictionary, this)
        this.$worker = $worker

        //
        this.$inbox.$messageHandler = this.$messageHandler
        this.$outbox[0].$messageHandler = this.$messageHandler
        this.$outbox[1].$messageHandler = this.$messageHandler

        //
        this.$dictionary._requestReflect = this.$requestReflect
        this.$dictionary._indirectReflect = this.$indirectReflect

        //
        this.$worker?.addEventListener?.("message", async (e) => {
            const $rw = await this.$inbox.decodeMessage(...this.$unchan(e.data, e))
            const $dc = $rw[0]
            if ($dc[0].$type == "request") {
                this.$responseTransmitters.set($dc[0].$id, new ResponseTransmitter($dc[0].$id, this))
            }
            this.$messageHandler.handleRequest(...$rw)
        })
    }

    //
    get ["&code"]() {
        return {
            "&typeof": "socket"
        }
    }

    //
    $feedback($param, $code) {
        // send back identifier
        this.$outbox
            .encodeMessage([{ ...$param, $type: "message", $args: [$code] }], [])
            .then((_args_) => {
                this.$worker?.emit?.("message", _args_[0][0])
            })
            .catch(console.error.bind(console))
    }

    //
    $request({ $type = "request", $worker = null, $async = false, $cmd, $args, $persistent }) {
        const $coder = {
            message: this.$outbox[1],
            request: this.$outbox[$async ? 1 : 0],
            response: this.$inbox
        }[$type]

        //
        const $buffer = new (typeof SharedArrayBuffer != "undefined" ? SharedArrayBuffer : ArrayBuffer)(4096 + 8, { maxByteLength: 65536 + 8 })
        const $tf = [],
            $id = this.$newUUID(),
            $rec = new ResponseReceiver($id, $buffer)
        this.$responseReceivers.set($id, $rec)

        //
        const $request = (_args_) => {
            // workaround transfer encoded message
            if (_args_.length == 1) _args_.push([])
            if (!_args_[1]) _args_[1] = []

            //
            this.$worker?.postMessage?.(this.$chan(_args_), _args_[1].filter(this.$detector.$dropShared.bind(this.$detector)))
        }

        //
        const $code = $coder.encodeMessage([{ $id, $type, $worker, $persistent, $cmd, $args }, $buffer, false], $tf)
        if ($code instanceof Promise) {
            $code.then($request)
        } else {
            $request($code)
        }

        //
        return new Proxy(
            wrapFunc({
                ["&data"]: $async ? $rec["&data"] : new SyncPromise($rec["&data"], $buffer, this.$outbox[0]),
                ["&code"]: {
                    ["&typeof"]: "promise"
                }
            }),
            this.$promiseReflect
        )
    }

    //
    $reject(...$args) {
        this.$worker?.postMessage?.($args, $args[1].filter(this.$detector.$dropShared.bind(this.$detector)))
    }

    //
    $resolve(...$args) {
        this.$worker?.postMessage?.($args, $args[1].filter(this.$detector.$dropShared.bind(this.$detector)))
    }
}

// ES6-modules alike (in v2.3 planned to complete quest)
export const WrapWorker = ($W, $options) => {
    return new Proxy(new WorkerHandler($W, $options), new WrapHandle(true))
}

//
STD.WrapWorker = WrapWorker
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfTE9HXyIsIk1lc3NhZ2VIYW5kbGVyIiwiUmVzcG9uc2VSZWNlaXZlciIsIlJlc3BvbnNlVHJhbnNtaXR0ZXIiLCJNZXNzYWdlQ29kZXJXb3JrZXIiLCJNZXNzYWdlQ29kZXJBdG9taWMiLCJCYXNlSGFuZGxlciIsIldyYXBIYW5kbGUiLCJ3cmFwRnVuYyIsIlN5bmNQcm9taXNlIiwiU1REIiwiV29ya2VySGFuZGxlciIsIiR3b3JrZXIiLCJjb25zdHJ1Y3RvciIsIiRvcHRpb25zIiwiJG91dGJveCIsIiRkZXRlY3RvciIsIiRkaWN0aW9uYXJ5IiwiJHJlcXVlc3RSZWZsZWN0IiwiJGluZGlyZWN0UmVmbGVjdCIsIiRwcm9taXNlUmVmbGVjdCIsIiRlbmNvZGUiLCJlbmNvZGUiLCIkZGVjb2RlIiwiZGVjb2RlIiwiJGhhbmRsZXIiLCIkaW5ib3giLCIkbWVzc2FnZUhhbmRsZXIiLCIkcmVzcG9uc2VSZWNlaXZlcnMiLCIkcmVzcG9uc2VUcmFuc21pdHRlcnMiLCJfcmVxdWVzdFJlZmxlY3QiLCJfaW5kaXJlY3RSZWZsZWN0IiwiYWRkRXZlbnRMaXN0ZW5lciIsImUiLCIkcnciLCJkZWNvZGVNZXNzYWdlIiwiJHVuY2hhbiIsImRhdGEiLCIkZGMiLCIkdHlwZSIsInNldCIsIiRpZCIsImhhbmRsZVJlcXVlc3QiLCImY29kZSIsIiRmZWVkYmFjayIsIiRwYXJhbSIsIiRjb2RlIiwiZW5jb2RlTWVzc2FnZSIsIiRhcmdzIiwidGhlbiIsIl9hcmdzXyIsImVtaXQiLCJjYXRjaCIsImNvbnNvbGUiLCJlcnJvciIsImJpbmQiLCIkcmVxdWVzdCIsIiRhc3luYyIsIiRjbWQiLCIkcGVyc2lzdGVudCIsIiRjb2RlciIsIiRidWZmZXIiLCJTaGFyZWRBcnJheUJ1ZmZlciIsIkFycmF5QnVmZmVyIiwibWF4Qnl0ZUxlbmd0aCIsIiR0ZiIsIiRuZXdVVUlEIiwiJHJlYyIsImxlbmd0aCIsInB1c2giLCJwb3N0TWVzc2FnZSIsIiRjaGFuIiwiZmlsdGVyIiwiJGRyb3BTaGFyZWQiLCJQcm9taXNlIiwiUHJveHkiLCIkcmVqZWN0IiwiJHJlc29sdmUiLCJXcmFwV29ya2VyIiwiJFciXSwic291cmNlcyI6WyJDOlxcUHJvamVjdHNcXEJaMFxcQkNvbTJcXHNyY1xcY2l2ZXRcXEhhbmRsZXJzXFxXb3JrZXJIYW5kbGVyLmNpdmV0Il0sInNvdXJjZXNDb250ZW50IjpbIi8vIEB0cy1ub2NoZWNrXG5cInVzZSBzdHJpY3RcIjtcblxuLy9cbmltcG9ydCB7IF9MT0dfIH0gZnJvbSBcIi4uL0xpYnJhcnkvU3ltYm9sc1wiO1xuaW1wb3J0IE1lc3NhZ2VIYW5kbGVyIGZyb20gXCIuLi9Qcm90b2NvbC9NZXNzYWdlSGFuZGxlclwiO1xuaW1wb3J0IFJlc3BvbnNlUmVjZWl2ZXIgZnJvbSBcIi4uL1Jlc3BvbnNlL1JlY2VpdmVyXCI7XG5pbXBvcnQgUmVzcG9uc2VUcmFuc21pdHRlciBmcm9tIFwiLi4vUmVzcG9uc2UvVHJhbnNtaXR0ZXJcIjtcblxuLy9cbmltcG9ydCBNZXNzYWdlQ29kZXJXb3JrZXIgZnJvbSBcIi4uL01lc3NhZ2VDb2Rlci9NZXNzYWdlQ29kZXJXb3JrZXJcIjtcbmltcG9ydCBNZXNzYWdlQ29kZXJBdG9taWMgZnJvbSBcIi4uL01lc3NhZ2VDb2Rlci9NZXNzYWdlQ29kZXJBdG9taWNcIjtcbmltcG9ydCBCYXNlSGFuZGxlciwge1dyYXBIYW5kbGV9IGZyb20gXCIuL0Jhc2VIYW5kbGVyXCI7XG5pbXBvcnQgeyB3cmFwRnVuYyB9IGZyb20gXCIuLi9SZWZsZWN0aW9uL0RpcmVjdFJlZmxlY3Rpb25cIjtcbmltcG9ydCBTeW5jUHJvbWlzZSBmcm9tIFwiLi4vTGlicmFyeS9TeW5jUHJvbWlzZVwiXG5cbi8vXG5pbXBvcnQgU1REIGZyb20gXCIuLi9MaWJyYXJ5L1N0YW5kYXJkXCI7XG5cbi8vXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBXb3JrZXJIYW5kbGVyIGV4dGVuZHMgQmFzZUhhbmRsZXIge1xuICAgICR3b3JrZXIgPSBudWxsO1xuXG4gICAgLyoqXG4gICAgICogTWFrZSBvYmplY3QgYXJlIGFjY2VzcyBpbnRvIG9iamVjdCBvciBjbGFzc1xuICAgICAqIEBwYXJhbSB7V29ya2VyfSAkd29ya2VyIFdlYldvcmtlciBvYmplY3RcbiAgICAgKiBAcGFyYW0ge09iamVjdH0gJG9wdGlvbnMgb3B0aW9ucyBvZiB3b3JrZXIgaGFuZGxlclxuICAgICAqIEByZXR1cm4ge1dvcmtlckhhbmRsZXJ9IFdvcmtlciBoYW5kbGVyIGFuZCB3cmFwcGVyXG4gICAgICovXG4gICAgY29uc3RydWN0b3IoJHdvcmtlciwgJG9wdGlvbnMgPSB7fSkge1xuICAgICAgICBzdXBlcigkd29ya2VyLCAkb3B0aW9ucyk7XG5cbiAgICAgICAgLy9cbiAgICAgICAgdGhpcy4kb3V0Ym94ID0gW1xuICAgICAgICAgICAgLy8gc3luY2hyb25vdXNcbiAgICAgICAgICAgIG5ldyBNZXNzYWdlQ29kZXJBdG9taWMoe1xuICAgICAgICAgICAgICAgICRkZXRlY3RvcjogdGhpcy4kZGV0ZWN0b3IsIFxuICAgICAgICAgICAgICAgICRkaWN0aW9uYXJ5OiB0aGlzLiRkaWN0aW9uYXJ5LCBcbiAgICAgICAgICAgICAgICAkcmVxdWVzdFJlZmxlY3Q6IHRoaXMuJHJlcXVlc3RSZWZsZWN0LCBcbiAgICAgICAgICAgICAgICAkaW5kaXJlY3RSZWZsZWN0OiB0aGlzLiRpbmRpcmVjdFJlZmxlY3QsIFxuICAgICAgICAgICAgICAgICRwcm9taXNlUmVmbGVjdDogdGhpcy4kcHJvbWlzZVJlZmxlY3QsXG4gICAgICAgICAgICAgICAgJGVuY29kZTogJG9wdGlvbnMuZW5jb2RlLFxuICAgICAgICAgICAgICAgICRkZWNvZGU6ICRvcHRpb25zLmRlY29kZSxcbiAgICAgICAgICAgICAgICAkaGFuZGxlcjogdGhpc1xuICAgICAgICAgICAgfSksXG5cbiAgICAgICAgICAgIC8vIGFzeW5jaHJvbm91c1xuICAgICAgICAgICAgbmV3IE1lc3NhZ2VDb2Rlcldvcmtlcih7XG4gICAgICAgICAgICAgICAgJGRldGVjdG9yOiB0aGlzLiRkZXRlY3RvciwgXG4gICAgICAgICAgICAgICAgJGRpY3Rpb25hcnk6IHRoaXMuJGRpY3Rpb25hcnksIFxuICAgICAgICAgICAgICAgICRyZXF1ZXN0UmVmbGVjdDogdGhpcy4kcmVxdWVzdFJlZmxlY3QsIFxuICAgICAgICAgICAgICAgICRpbmRpcmVjdFJlZmxlY3Q6IHRoaXMuJGluZGlyZWN0UmVmbGVjdCwgXG4gICAgICAgICAgICAgICAgJHByb21pc2VSZWZsZWN0OiB0aGlzLiRwcm9taXNlUmVmbGVjdCxcbiAgICAgICAgICAgICAgICAkZW5jb2RlOiAkb3B0aW9ucy5lbmNvZGUsXG4gICAgICAgICAgICAgICAgJGRlY29kZTogJG9wdGlvbnMuZGVjb2RlLFxuICAgICAgICAgICAgICAgICRoYW5kbGVyOiB0aGlzXG4gICAgICAgICAgICB9KSxcbiAgICAgICAgXTtcblxuICAgICAgICAvL1xuICAgICAgICB0aGlzLiRpbmJveCA9IG5ldyBNZXNzYWdlQ29kZXJXb3JrZXIoe1xuICAgICAgICAgICAgJGRldGVjdG9yOiB0aGlzLiRkZXRlY3RvciwgXG4gICAgICAgICAgICAkZGljdGlvbmFyeTogdGhpcy4kZGljdGlvbmFyeSwgXG4gICAgICAgICAgICAkcmVxdWVzdFJlZmxlY3Q6IHRoaXMuJHJlcXVlc3RSZWZsZWN0LCBcbiAgICAgICAgICAgICRpbmRpcmVjdFJlZmxlY3Q6IHRoaXMuJGluZGlyZWN0UmVmbGVjdCwgXG4gICAgICAgICAgICAkcHJvbWlzZVJlZmxlY3Q6IHRoaXMuJHByb21pc2VSZWZsZWN0LFxuICAgICAgICAgICAgJGVuY29kZTogJG9wdGlvbnMuZW5jb2RlLFxuICAgICAgICAgICAgJGRlY29kZTogJG9wdGlvbnMuZGVjb2RlLFxuICAgICAgICAgICAgJGhhbmRsZXI6IHRoaXNcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy9cbiAgICAgICAgdGhpcy4kbWVzc2FnZUhhbmRsZXIgPSBuZXcgTWVzc2FnZUhhbmRsZXIodGhpcy4kcmVzcG9uc2VSZWNlaXZlcnMsIHRoaXMuJHJlc3BvbnNlVHJhbnNtaXR0ZXJzLCB0aGlzLiRvdXRib3hbMV0sIHRoaXMuJGRpY3Rpb25hcnksIHRoaXMpO1xuICAgICAgICB0aGlzLiR3b3JrZXIgPSAkd29ya2VyO1xuXG4gICAgICAgIC8vXG4gICAgICAgIHRoaXMuJGluYm94LiRtZXNzYWdlSGFuZGxlciA9IHRoaXMuJG1lc3NhZ2VIYW5kbGVyO1xuICAgICAgICB0aGlzLiRvdXRib3hbMF0uJG1lc3NhZ2VIYW5kbGVyID0gdGhpcy4kbWVzc2FnZUhhbmRsZXI7XG4gICAgICAgIHRoaXMuJG91dGJveFsxXS4kbWVzc2FnZUhhbmRsZXIgPSB0aGlzLiRtZXNzYWdlSGFuZGxlcjtcblxuICAgICAgICAvL1xuICAgICAgICB0aGlzLiRkaWN0aW9uYXJ5Ll9yZXF1ZXN0UmVmbGVjdCA9IHRoaXMuJHJlcXVlc3RSZWZsZWN0O1xuICAgICAgICB0aGlzLiRkaWN0aW9uYXJ5Ll9pbmRpcmVjdFJlZmxlY3QgPSB0aGlzLiRpbmRpcmVjdFJlZmxlY3Q7XG5cbiAgICAgICAgLy9cbiAgICAgICAgdGhpcy4kd29ya2VyPy5hZGRFdmVudExpc3RlbmVyPy4oXCJtZXNzYWdlXCIsIGFzeW5jIChlKSA9PiB7XG4gICAgICAgICAgICBjb25zdCAkcncgPSBhd2FpdCB0aGlzLiRpbmJveC5kZWNvZGVNZXNzYWdlKC4uLnRoaXMuJHVuY2hhbihlLmRhdGEsIGUpKTtcbiAgICAgICAgICAgIGNvbnN0ICRkYyA9ICRyd1swXTtcbiAgICAgICAgICAgIGlmICgkZGNbMF0uJHR5cGUgPT0gXCJyZXF1ZXN0XCIpIHtcbiAgICAgICAgICAgICAgICB0aGlzLiRyZXNwb25zZVRyYW5zbWl0dGVycy5zZXQoJGRjWzBdLiRpZCwgbmV3IFJlc3BvbnNlVHJhbnNtaXR0ZXIoJGRjWzBdLiRpZCwgdGhpcykpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHRoaXMuJG1lc3NhZ2VIYW5kbGVyLmhhbmRsZVJlcXVlc3QoLi4uJHJ3KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy9cbiAgICBnZXQgW1wiJmNvZGVcIl0oKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBcIiZ0eXBlb2ZcIjogXCJzb2NrZXRcIlxuICAgICAgICB9XG4gICAgfVxuXG4gICAgLy9cbiAgICAkZmVlZGJhY2soJHBhcmFtLCAkY29kZSkge1xuXG4gICAgICAgIC8vIHNlbmQgYmFjayBpZGVudGlmaWVyXG4gICAgICAgIHRoaXMuJG91dGJveC5lbmNvZGVNZXNzYWdlKFt7IC4uLiRwYXJhbSwgJHR5cGU6IFwibWVzc2FnZVwiLCAkYXJnczogWyRjb2RlXSB9XSwgW10pLnRoZW4oKF9hcmdzXykgPT4ge1xuICAgICAgICAgICAgdGhpcy4kd29ya2VyPy5lbWl0Py4oXCJtZXNzYWdlXCIsIF9hcmdzX1swXVswXSk7XG4gICAgICAgIH0pLmNhdGNoKGNvbnNvbGUuZXJyb3IuYmluZChjb25zb2xlKSk7XG5cbiAgICB9XG5cbiAgICAvL1xuICAgICRyZXF1ZXN0KHskdHlwZSA9IFwicmVxdWVzdFwiLCAkd29ya2VyID0gbnVsbCwgJGFzeW5jID0gZmFsc2UsICRjbWQsICRhcmdzLCAkcGVyc2lzdGVudH0pIHtcbiAgICAgICAgY29uc3QgJGNvZGVyID0gKHtcbiAgICAgICAgICAgIFwibWVzc2FnZVwiOiB0aGlzLiRvdXRib3hbMV0sIFxuICAgICAgICAgICAgXCJyZXF1ZXN0XCI6IHRoaXMuJG91dGJveFskYXN5bmMgPyAxIDogMF0sIFxuICAgICAgICAgICAgXCJyZXNwb25zZVwiOiB0aGlzLiRpbmJveCxcbiAgICAgICAgfVskdHlwZV0pO1xuXG4gICAgICAgIC8vXG4gICAgICAgIGNvbnN0ICRidWZmZXIgPSBuZXcgKHR5cGVvZiBTaGFyZWRBcnJheUJ1ZmZlciAhPSBcInVuZGVmaW5lZFwiID8gIFNoYXJlZEFycmF5QnVmZmVyIDogQXJyYXlCdWZmZXIpKDQwOTYrOCwgeyBtYXhCeXRlTGVuZ3RoOiA2NTUzNis4IH0pO1xuICAgICAgICBjb25zdCAkdGYgPSBbXSwgJGlkID0gdGhpcy4kbmV3VVVJRCgpLCAkcmVjID0gbmV3IFJlc3BvbnNlUmVjZWl2ZXIoJGlkLCAkYnVmZmVyKTtcbiAgICAgICAgdGhpcy4kcmVzcG9uc2VSZWNlaXZlcnMuc2V0KCRpZCwgJHJlYyk7XG5cbiAgICAgICAgLy9cbiAgICAgICAgY29uc3QgJHJlcXVlc3QgPSAoX2FyZ3NfKSA9PiB7XG4gICAgICAgICAgICAvLyB3b3JrYXJvdW5kIHRyYW5zZmVyIGVuY29kZWQgbWVzc2FnZVxuICAgICAgICAgICAgaWYgKF9hcmdzXy5sZW5ndGggPT0gMSkgIF9hcmdzXy5wdXNoKFtdKTsgXG4gICAgICAgICAgICBpZiAoIV9hcmdzX1sxXSkgX2FyZ3NfWzFdID0gW107XG5cbiAgICAgICAgICAgIC8vXG4gICAgICAgICAgICB0aGlzLiR3b3JrZXI/LnBvc3RNZXNzYWdlPy4odGhpcy4kY2hhbihfYXJnc18pLCBfYXJnc19bMV0uZmlsdGVyKHRoaXMuJGRldGVjdG9yLiRkcm9wU2hhcmVkLmJpbmQodGhpcy4kZGV0ZWN0b3IpKSk7XG4gICAgICAgIH07XG5cbiAgICAgICAgLy9cbiAgICAgICAgY29uc3QgJGNvZGUgPSAkY29kZXIuZW5jb2RlTWVzc2FnZShbeyAkaWQsICR0eXBlLCAkd29ya2VyLCAkcGVyc2lzdGVudCwgJGNtZCwgJGFyZ3MgfSwgJGJ1ZmZlciwgZmFsc2VdLCAkdGYpO1xuICAgICAgICBpZiAoJGNvZGUgaW5zdGFuY2VvZiBQcm9taXNlKSBcbiAgICAgICAgICAgICRjb2RlLnRoZW4oJHJlcXVlc3QpOyBcbiAgICAgICAgZWxzZSBcbiAgICAgICAgICAgICRjb2RlIHw+ICRyZXF1ZXN0O1xuXG4gICAgICAgIC8vXG4gICAgICAgIHJldHVybiBuZXcgUHJveHkod3JhcEZ1bmMoe1xuICAgICAgICAgICAgW1wiJmRhdGFcIl06ICgkYXN5bmMgPyAkcmVjW1wiJmRhdGFcIl0gOiBuZXcgU3luY1Byb21pc2UoJHJlY1tcIiZkYXRhXCJdLCAkYnVmZmVyLCB0aGlzLiRvdXRib3hbMF0pKSxcbiAgICAgICAgICAgIFtcIiZjb2RlXCJdOiB7XG4gICAgICAgICAgICAgICAgW1wiJnR5cGVvZlwiXTogXCJwcm9taXNlXCJcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSksIHRoaXMuJHByb21pc2VSZWZsZWN0KTtcbiAgICB9XG5cbiAgICAvL1xuICAgICRyZWplY3QoLi4uJGFyZ3MpIHtcbiAgICAgICAgdGhpcy4kd29ya2VyPy5wb3N0TWVzc2FnZT8uKCRhcmdzLCAkYXJnc1sxXS5maWx0ZXIodGhpcy4kZGV0ZWN0b3IuJGRyb3BTaGFyZWQuYmluZCh0aGlzLiRkZXRlY3RvcikpKTtcbiAgICB9XG5cbiAgICAvL1xuICAgICRyZXNvbHZlKC4uLiRhcmdzKSB7XG4gICAgICAgIHRoaXMuJHdvcmtlcj8ucG9zdE1lc3NhZ2U/LigkYXJncywgJGFyZ3NbMV0uZmlsdGVyKHRoaXMuJGRldGVjdG9yLiRkcm9wU2hhcmVkLmJpbmQodGhpcy4kZGV0ZWN0b3IpKSk7XG4gICAgfVxufTtcblxuLy8gRVM2LW1vZHVsZXMgYWxpa2UgKGluIHYyLjMgcGxhbm5lZCB0byBjb21wbGV0ZSBxdWVzdClcbmV4cG9ydCBjb25zdCBXcmFwV29ya2VyID0gKCRXLCAkb3B0aW9ucykgPT4ge1xuICAgIHJldHVybiBuZXcgUHJveHkobmV3IFdvcmtlckhhbmRsZXIoJFcsICRvcHRpb25zKSwgbmV3IFdyYXBIYW5kbGUodHJ1ZSkpO1xufVxuXG4vL1xuU1RELldyYXBXb3JrZXIgPSBXcmFwV29ya2VyO1xuIl0sIm1hcHBpbmdzIjoiQUFBQTtBQUNBLFk7O0FBRUE7QUFDQSxTQUFTQSxLQUFLO0FBQ2QsT0FBT0MsY0FBYztBQUNyQixPQUFPQyxnQkFBZ0I7QUFDdkIsT0FBT0MsbUJBQW1COztBQUUxQjtBQUNBLE9BQU9DLGtCQUFrQjtBQUN6QixPQUFPQyxrQkFBa0I7QUFDekIsT0FBT0MsV0FBVyxJQUFHQyxVQUFVO0FBQy9CLFNBQVNDLFFBQVE7QUFDakIsT0FBT0MsV0FBVzs7QUFFbEI7QUFDQSxPQUFPQyxH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
