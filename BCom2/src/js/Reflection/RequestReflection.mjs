// @ts-nocheck
"use strict"

//
import PromiseReflection, { $unwrap } from "./PromiseReflection.mjs"
import { $symbols, $names, _LOG_ } from "../Library/Symbols.mjs"
import { wrapFunc, BaseReflection } from "./DirectReflection.mjs"

// from remote side...
export default class RequestReflection extends BaseReflection {
    /** @type {WorkerHandler|SocketHandler|BaseHandler} */
    $worker = null

    /** @type {Boolean} */
    $async = false

    /** */
    $queue = []

    //
    constructor(worker, $async = false) {
        super(Reflect)
        this.$worker = worker
        this.$async = $async
    }

    //
    $func($p) {
        return $p instanceof Promise ? wrapFunc({ ["&data"]: $p, ["&code"]: { ["&typeof"]: "promise" } }) : $p
    }
    $data($hack) {
        return new Proxy($hack, this)
    }
    $wrap($p) {
        return new Proxy(this.$func($p), new PromiseReflection())
    }
    $seq() {
        const $q = Promise.all(this.$queue)
        this.$queue = [$q]
        return $q
    }
    $inc($p) {
        this.$queue.push($p)
        return $p
    }

    // indirect and direct versions
    $do($fn) {
        return this.$wrap(this.$inc(this.$seq().then($fn)))
    }
    //$do($fn) { return $fn(); }

    //
    get($hack, ...$args) {
        if ($args[0] == "&isCode") return false
        if ($args[0] == "&isWrap") return true
        if (["&data", "&code"].indexOf($args[0]) >= 0) return $hack?.[$args[0]]
        if ([$symbols["&data"]].indexOf($args[0]) >= 0) return this.$data($hack)
        if ($args[0]?.at?.(0) == "&") return $hack?.["&code"]?.[$args[0]]

        //
        if (Object.values($symbols).indexOf($args[0]) >= 0) {
            $args[0] = $names[$args[0]]
            return this.$wrap(
                this.$inc(
                    this.$seq().then(() => {
                        return this.$worker.$request({
                            $cmd: "get",
                            $identify: true,
                            $async: $hack["&async"] ?? false,
                            $args: [this.$data($hack), ...$args]
                        })
                    })
                )
            )
        }

        //
        if (["then", "catch", "finally"].indexOf($args[0]) >= 0) {
            /*const $g = this.$do(() => {
          return this.$worker.$request({
              $cmd: "access", 
              $identify: true, 
              $async: true, 
              $args: [this.$data($hack), ...$args]
          })
      });
      return $g[$args[0]]?.bind?.($g);*/
            return null
        }

        //
        if (["bind", "call", "apply"].indexOf($args[0]) >= 0) {
            const $worker = this.$worker
            const $data = this.$data($hack)
            const $async = this.$async
            const $fn = (...$arg) => {
                return this.$do(() => {
                    return this.$worker.$request({
                        $cmd: "apply",
                        $identify: true,
                        $async: $hack["$async"] ?? $async,
                        $args: [$data, $args[1], $arg]
                    })
                })
            }
            return $fn[$args[0]].bind($fn)
        }

        // usable only for callbacks
        // TODO! needs to reworking!
        /*if (["*"].indexOf($args[0]) >= 0) {
        const $worker = this.$worker;
        const $data = this.$data($hack);
        const $async = this.$async;
        const $fn = (...$arg) => {
            return $worker.$request({
                $cmd: "apply", 
                $identify: true, 
                $async, 
                $args: [$data, $arg, $args[1]]
            });
        };
        return $fn.bind(this);
    }*/

        //
        if (["string", "number", "boolean", "bigint"].indexOf(typeof $args[0]) >= 0) {
            const $async = !($args[0]?.at?.(-1) == "*") ?? false
            if (!$async) $args[0] = $args[0]?.slice?.(0, -1)
            const $g = this.$do(() => {
                return this.$worker.$request({
                    $cmd: "get",
                    $identify: true,
                    $async: $hack["$async"] ?? this.$async,
                    $args: [this.$data($hack), ...$args]
                })
            })
            return $async ? $g : $g["*"]
        }
        return
    }

    //
    ownKeys($hack, ...$args) {
        return this.$do(() => {
            return this.$worker.$request({
                $cmd: "ownKeys",
                $identify: true,
                $async: $hack["$async"] ?? this.$async,
                $args: [this.$data($hack), ...$args]
            })
        })
    }

    //
    has($hack, ...$args) {
        if (["string", "number", "boolean", "bigint"].indexOf(typeof $args[0]) >= 0) {
            return this.$do(() => {
                return this.$worker.$request({
                    $cmd: "has",
                    $identify: true,
                    $async: $hack["$async"] ?? this.$async,
                    $args: [this.$data($hack), ...$args]
                })
            })
        }
        return
    }

    //
    set($hack, ...$args) {
        if (["string", "number", "boolean", "bigint"].indexOf(typeof $args[0]) >= 0) {
            const $async = !($args[0]?.at?.(-1) == "*") ?? false
            if (!$async) $args[0] = $args[0]?.slice?.(0, -1)
            const $g = this.$do(() => {
                return this.$worker.$request({
                    $cmd: "set",
                    $identify: true,
                    $async: true, //$hack["$async"] ?? this.$async,
                    $args: [this.$data($hack), ...$args]
                })
            })
            return ($async ? $g : $g["*"]) != null
        }
        return
    }

    //
    construct($hack, ...$args) {
        return this.$do(() => {
            return this.$worker.$request({
                $cmd: "construct",
                $identify: true,
                $async: true, //$hack["$async"] ?? this.$async,
                $args: [this.$data($hack), ...$args]
            })
        })
    }

    //
    apply($hack, ...$args) {
        return this.$do(() => {
            return this.$worker.$request({
                $cmd: "apply",
                $identify: true,
                $async: true, //$hack["$async"] ?? this.$async,
                $args: [this.$data($hack), ...$args]
            })
        })
    }

    //
    deleteProperty($hack, ...$args) {
        return this.$do(() => {
            return this.$worker.$request({
                $cmd: "deleteProperty",
                $identify: true,
                $async: $hack["$async"] ?? this.$async,
                $args: [this.$data($hack), ...$args]
            })
        })
    }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJQcm9taXNlUmVmbGVjdGlvbiIsIiR1bndyYXAiLCIkc3ltYm9scyIsIiRuYW1lcyIsIl9MT0dfIiwid3JhcEZ1bmMiLCJCYXNlUmVmbGVjdGlvbiIsIlJlcXVlc3RSZWZsZWN0aW9uIiwiJHdvcmtlciIsIiRhc3luYyIsIiRxdWV1ZSIsImNvbnN0cnVjdG9yIiwid29ya2VyIiwiUmVmbGVjdCIsIiRmdW5jIiwiJHAiLCJQcm9taXNlIiwiJGRhdGEiLCIkaGFjayIsIlByb3h5IiwiJHdyYXAiLCIkc2VxIiwiJHEiLCJhbGwiLCIkaW5jIiwicHVzaCIsIiRkbyIsIiRmbiIsInRoZW4iLCJnZXQiLCIkYXJncyIsImluZGV4T2YiLCJhdCIsIk9iamVjdCIsInZhbHVlcyIsIiRyZXF1ZXN0IiwiJGNtZCIsIiRpZGVudGlmeSIsIiRhcmciLCJiaW5kIiwic2xpY2UiLCIkZyIsIm93bktleXMiLCJoYXMiLCJzZXQiLCJjb25zdHJ1Y3QiLCJhcHBseSIsImRlbGV0ZVByb3BlcnR5Il0sInNvdXJjZXMiOlsiQzpcXFByb2plY3RzXFxCWjBcXEJDb20yXFxzcmNcXGNpdmV0XFxSZWZsZWN0aW9uXFxSZXF1ZXN0UmVmbGVjdGlvbi5jaXZldCJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAdHMtbm9jaGVja1xuXCJ1c2Ugc3RyaWN0XCI7XG5cbi8vXG5pbXBvcnQgUHJvbWlzZVJlZmxlY3Rpb24sIHsgJHVud3JhcCB9IGZyb20gXCIuL1Byb21pc2VSZWZsZWN0aW9uXCI7XG5pbXBvcnQgeyAkc3ltYm9scywgJG5hbWVzLCBfTE9HXyB9IGZyb20gXCIuLi9MaWJyYXJ5L1N5bWJvbHNcIjtcbmltcG9ydCB7IHdyYXBGdW5jLCBCYXNlUmVmbGVjdGlvbiB9IGZyb20gXCIuL0RpcmVjdFJlZmxlY3Rpb25cIjtcblxuLy8gZnJvbSByZW1vdGUgc2lkZS4uLlxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUmVxdWVzdFJlZmxlY3Rpb24gZXh0ZW5kcyBCYXNlUmVmbGVjdGlvbiB7XG4gICAgLyoqIEB0eXBlIHtXb3JrZXJIYW5kbGVyfFNvY2tldEhhbmRsZXJ8QmFzZUhhbmRsZXJ9ICovXG4gICAgJHdvcmtlciA9IG51bGw7XG5cbiAgICAvKiogQHR5cGUge0Jvb2xlYW59ICovXG4gICAgJGFzeW5jID0gZmFsc2U7XG5cbiAgICAvKiogKi9cbiAgICAkcXVldWUgPSBbXTtcblxuICAgIC8vXG4gICAgY29uc3RydWN0b3Iod29ya2VyLCAkYXN5bmMgPSBmYWxzZSkge1xuICAgICAgICBzdXBlcihSZWZsZWN0KTtcbiAgICAgICAgdGhpcy4kd29ya2VyID0gd29ya2VyO1xuICAgICAgICB0aGlzLiRhc3luYyA9ICRhc3luYztcbiAgICB9XG5cbiAgICAvL1xuICAgICRmdW5jKCRwKSB7IHJldHVybiAoJHAgaW5zdGFuY2VvZiBQcm9taXNlKSA/IHdyYXBGdW5jKHtbXCImZGF0YVwiXTogJHAsIFtcIiZjb2RlXCJdOiB7W1wiJnR5cGVvZlwiXTogXCJwcm9taXNlXCJ9fSkgOiAkcDsgfVxuICAgICRkYXRhKCRoYWNrKSB7IHJldHVybiBuZXcgUHJveHkoJGhhY2ssIHRoaXMpOyB9XG4gICAgJHdyYXAoJHApIHsgcmV0dXJuIG5ldyBQcm94eSh0aGlzLiRmdW5jKCRwKSwgbmV3IFByb21pc2VSZWZsZWN0aW9uKCkpOyB9XG4gICAgJHNlcSgpIHsgY29uc3QgJHEgPSBQcm9taXNlLmFsbCh0aGlzLiRxdWV1ZSk7IHRoaXMuJHF1ZXVlID0gWyRxXTsgcmV0dXJuICRxOyB9XG4gICAgJGluYygkcCkgeyB0aGlzLiRxdWV1ZS5wdXNoKCRwKTsgcmV0dXJuICRwOyB9XG5cbiAgICAvLyBpbmRpcmVjdCBhbmQgZGlyZWN0IHZlcnNpb25zXG4gICAgJGRvKCRmbikgeyByZXR1cm4gKHRoaXMuJHNlcSgpLnRoZW4oJGZuKSB8PiB0aGlzLiRpbmMpIHw+IHRoaXMuJHdyYXA7IH1cbiAgICAvLyRkbygkZm4pIHsgcmV0dXJuICRmbigpOyB9XG5cbiAgICAvL1xuICAgIGdldCgkaGFjaywgLi4uJGFyZ3MpIHtcbiAgICAgICAgaWYgKCRhcmdzWzBdID09IFwiJmlzQ29kZVwiKSByZXR1cm4gZmFsc2U7XG4gICAgICAgIGlmICgkYXJnc1swXSA9PSBcIiZpc1dyYXBcIikgcmV0dXJuIHRydWU7XG4gICAgICAgIGlmIChbXCImZGF0YVwiLCBcIiZjb2RlXCJdLmluZGV4T2YoJGFyZ3NbMF0pID49IDApIHJldHVybiAkaGFjaz8uWyRhcmdzWzBdXTtcbiAgICAgICAgaWYgKFskc3ltYm9sc1tcIiZkYXRhXCJdXS5pbmRleE9mKCRhcmdzWzBdKSA+PSAwKSByZXR1cm4gdGhpcy4kZGF0YSgkaGFjayk7XG4gICAgICAgIGlmICgkYXJnc1swXT8uYXQ/LigwKSA9PSBcIiZcIikgcmV0dXJuICRoYWNrPy5bXCImY29kZVwiXT8uWyRhcmdzWzBdXTtcblxuICAgICAgICAvL1xuICAgICAgICBpZiAoT2JqZWN0LnZhbHVlcygkc3ltYm9scykuaW5kZXhPZigkYXJnc1swXSkgPj0gMCkgeyBcbiAgICAgICAgICAgICRhcmdzWzBdID0gJG5hbWVzWyRhcmdzWzBdXTtcbiAgICAgICAgICAgIHJldHVybiAodGhpcy4kc2VxKCkudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuJHdvcmtlci4kcmVxdWVzdCh7XG4gICAgICAgICAgICAgICAgICAgICRjbWQ6IFwiZ2V0XCIsIFxuICAgICAgICAgICAgICAgICAgICAkaWRlbnRpZnk6IHRydWUsIFxuICAgICAgICAgICAgICAgICAgICAkYXN5bmM6ICRoYWNrW1wiJmFzeW5jXCJdID8/IGZhbHNlLCBcbiAgICAgICAgICAgICAgICAgICAgJGFyZ3M6IFt0aGlzLiRkYXRhKCRoYWNrKSwgLi4uJGFyZ3NdXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH0pIHw+IHRoaXMuJGluYykgfD4gdGhpcy4kd3JhcDtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vXG4gICAgICAgIGlmIChbXCJ0aGVuXCIsIFwiY2F0Y2hcIiwgXCJmaW5hbGx5XCJdLmluZGV4T2YoJGFyZ3NbMF0pID49IDApIHtcbiAgICAgICAgICAgIC8qY29uc3QgJGcgPSB0aGlzLiRkbygoKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuJHdvcmtlci4kcmVxdWVzdCh7XG4gICAgICAgICAgICAgICAgICAgICRjbWQ6IFwiYWNjZXNzXCIsIFxuICAgICAgICAgICAgICAgICAgICAkaWRlbnRpZnk6IHRydWUsIFxuICAgICAgICAgICAgICAgICAgICAkYXN5bmM6IHRydWUsIFxuICAgICAgICAgICAgICAgICAgICAkYXJnczogW3RoaXMuJGRhdGEoJGhhY2spLCAuLi4kYXJnc11cbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXR1cm4gJGdbJGFyZ3NbMF1dPy5iaW5kPy4oJGcpOyovXG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vXG4gICAgICAgIGlmIChbXCJiaW5kXCIsIFwiY2FsbFwiLCBcImFwcGx5XCJdLmluZGV4T2YoJGFyZ3NbMF0pID49IDApIHtcbiAgICAgICAgICAgIGNvbnN0ICR3b3JrZXIgPSB0aGlzLiR3b3JrZXI7XG4gICAgICAgICAgICBjb25zdCAkZGF0YSA9IHRoaXMuJGRhdGEoJGhhY2spO1xuICAgICAgICAgICAgY29uc3QgJGFzeW5jID0gdGhpcy4kYXN5bmM7XG4gICAgICAgICAgICBjb25zdCAkZm4gPSAoLi4uJGFyZykgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLiRkbygoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLiR3b3JrZXIuJHJlcXVlc3Qoe1xuICAgICAgICAgICAgICAgICAgICAgICAgJGNtZDogXCJhcHBseVwiLCBcbiAgICAgICAgICAgICAgICAgICAgICAgICRpZGVudGlmeTogdHJ1ZSwgXG4gICAgICAgICAgICAgICAgICAgICAgICAkYXN5bmM6ICRoYWNrW1wiJGFzeW5jXCJdID8/ICRhc3luYywgXG4gICAgICAgICAgICAgICAgICAgICAgICAkYXJnczogWyRkYXRhLCAkYXJnc1sxXSwgJGFyZ11cbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICByZXR1cm4gJGZuWyRhcmdzWzBdXS5iaW5kKCRmbik7XG4gICAgICAgIH1cblxuICAgICAgICAvLyB1c2FibGUgb25seSBmb3IgY2FsbGJhY2tzXG4gICAgICAgIC8vIFRPRE8hIG5lZWRzIHRvIHJld29ya2luZyFcbiAgICAgICAgLyppZiAoW1wiKlwiXS5pbmRleE9mKCRhcmdzWzBdKSA+PSAwKSB7XG4gICAgICAgICAgICBjb25zdCAkd29ya2VyID0gdGhpcy4kd29ya2VyO1xuICAgICAgICAgICAgY29uc3QgJGRhdGEgPSB0aGlzLiRkYXRhKCRoYWNrKTtcbiAgICAgICAgICAgIGNvbnN0ICRhc3luYyA9IHRoaXMuJGFzeW5jO1xuICAgICAgICAgICAgY29uc3QgJGZuID0gKC4uLiRhcmcpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gJHdvcmtlci4kcmVxdWVzdCh7XG4gICAgICAgICAgICAgICAgICAgICRjbWQ6IFwiYXBwbHlcIiwgXG4gICAgICAgICAgICAgICAgICAgICRpZGVudGlmeTogdHJ1ZSwgXG4gICAgICAgICAgICAgICAgICAgICRhc3luYywgXG4gICAgICAgICAgICAgICAgICAgICRhcmdzOiBbJGRhdGEsICRhcmcsICRhcmdzWzFdXVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHJldHVybiAkZm4uYmluZCh0aGlzKTtcbiAgICAgICAgfSovXG5cbiAgICAgICAgLy9cbiAgICAgICAgaWYgKFtcInN0cmluZ1wiLCBcIm51bWJlclwiLCBcImJvb2xlYW5cIiwgXCJiaWdpbnRcIl0uaW5kZXhPZih0eXBlb2YgJGFyZ3NbMF0pID49IDApIHtcbiAgICAgICAgICAgIGNvbnN0ICRhc3luYyA9ICEoJGFyZ3NbMF0/LmF0Py4oLTEpID09IFwiKlwiKSA/PyBmYWxzZTtcbiAgICAgICAgICAgIGlmICghJGFzeW5jKSAkYXJnc1swXSA9ICRhcmdzWzBdPy5zbGljZT8uKDAsIC0xKTtcbiAgICAgICAgICAgIGNvbnN0ICRnID0gdGhpcy4kZG8oKCkgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLiR3b3JrZXIuJHJlcXVlc3Qoe1xuICAgICAgICAgICAgICAgICAgICAkY21kOiBcImdldFwiLCBcbiAgICAgICAgICAgICAgICAgICAgJGlkZW50aWZ5OiB0cnVlLCBcbiAgICAgICAgICAgICAgICAgICAgJGFzeW5jOiAkaGFja1tcIiRhc3luY1wiXSA/PyB0aGlzLiRhc3luYywgXG4gICAgICAgICAgICAgICAgICAgICRhcmdzOiBbdGhpcy4kZGF0YSgkaGFjayksIC4uLiRhcmdzXVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJldHVybiAoJGFzeW5jID8gJGcgOiAkZ1tcIipcIl0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLy9cbiAgICBvd25LZXlzKCRoYWNrLCAuLi4kYXJncykge1xuICAgICAgICByZXR1cm4gdGhpcy4kZG8oKCkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuJHdvcmtlci4kcmVxdWVzdCh7XG4gICAgICAgICAgICAgICAgJGNtZDogXCJvd25LZXlzXCIsIFxuICAgICAgICAgICAgICAgICRpZGVudGlmeTogdHJ1ZSwgXG4gICAgICAgICAgICAgICAgJGFzeW5jOiAkaGFja1tcIiRhc3luY1wiXSA/PyB0aGlzLiRhc3luYywgXG4gICAgICAgICAgICAgICAgJGFyZ3M6IFt0aGlzLiRkYXRhKCRoYWNrKSwgLi4uJGFyZ3NdXG4gICAgICAgICAgICB9KVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvL1xuICAgIGhhcygkaGFjaywgLi4uJGFyZ3MpIHtcbiAgICAgICAgaWYgKFtcInN0cmluZ1wiLCBcIm51bWJlclwiLCBcImJvb2xlYW5cIiwgXCJiaWdpbnRcIl0uaW5kZXhPZih0eXBlb2YgJGFyZ3NbMF0pID49IDApIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLiRkbygoKT0+e1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLiR3b3JrZXIuJHJlcXVlc3Qoe1xuICAgICAgICAgICAgICAgICAgICAkY21kOiBcImhhc1wiLCBcbiAgICAgICAgICAgICAgICAgICAgJGlkZW50aWZ5OiB0cnVlLCBcbiAgICAgICAgICAgICAgICAgICAgJGFzeW5jOiAkaGFja1tcIiRhc3luY1wiXSA/PyB0aGlzLiRhc3luYywgXG4gICAgICAgICAgICAgICAgICAgICRhcmdzOiBbdGhpcy4kZGF0YSgkaGFjayksIC4uLiRhcmdzXVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vXG4gICAgc2V0KCRoYWNrLCAuLi4kYXJncykge1xuICAgICAgICBpZiAoW1wic3RyaW5nXCIsIFwibnVtYmVyXCIsIFwiYm9vbGVhblwiLCBcImJpZ2ludFwiXS5pbmRleE9mKHR5cGVvZiAkYXJnc1swXSkgPj0gMCkge1xuICAgICAgICAgICAgY29uc3QgJGFzeW5jID0gISgkYXJnc1swXT8uYXQ/LigtMSkgPT0gXCIqXCIpID8/IGZhbHNlO1xuICAgICAgICAgICAgaWYgKCEkYXN5bmMpICRhcmdzWzBdID0gJGFyZ3NbMF0/LnNsaWNlPy4oMCwgLTEpO1xuICAgICAgICAgICAgY29uc3QgJGcgPSB0aGlzLiRkbygoKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuJHdvcmtlci4kcmVxdWVzdCh7XG4gICAgICAgICAgICAgICAgICAgICRjbWQ6IFwic2V0XCIsIFxuICAgICAgICAgICAgICAgICAgICAkaWRlbnRpZnk6IHRydWUsIFxuICAgICAgICAgICAgICAgICAgICAkYXN5bmM6IHRydWUsIC8vJGhhY2tbXCIkYXN5bmNcIl0gPz8gdGhpcy4kYXN5bmMsIFxuICAgICAgICAgICAgICAgICAgICAkYXJnczogW3RoaXMuJGRhdGEoJGhhY2spLCAuLi4kYXJnc11cbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXR1cm4gKCRhc3luYyA/ICRnIDogJGdbXCIqXCJdKT87XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBcbiAgICBjb25zdHJ1Y3QoJGhhY2ssIC4uLiRhcmdzKSB7XG4gICAgICAgIHJldHVybiB0aGlzLiRkbygoKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy4kd29ya2VyLiRyZXF1ZXN0KHtcbiAgICAgICAgICAgICAgICAkY21kOiBcImNvbnN0cnVjdFwiLCBcbiAgICAgICAgICAgICAgICAkaWRlbnRpZnk6IHRydWUsIFxuICAgICAgICAgICAgICAgICRhc3luYzogdHJ1ZSwvLyRoYWNrW1wiJGFzeW5jXCJdID8/IHRoaXMuJGFzeW5jLCBcbiAgICAgICAgICAgICAgICAkYXJnczogW3RoaXMuJGRhdGEoJGhhY2spLCAuLi4kYXJnc11cbiAgICAgICAgICAgIH0pXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vXG4gICAgYXBwbHkoJGhhY2ssIC4uLiRhcmdzKSB7XG4gICAgICAgIHJldHVybiB0aGlzLiRkbygoKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy4kd29ya2VyLiRyZXF1ZXN0KHtcbiAgICAgICAgICAgICAgICAkY21kOiBcImFwcGx5XCIsIFxuICAgICAgICAgICAgICAgICRpZGVudGlmeTogdHJ1ZSwgXG4gICAgICAgICAgICAgICAgJGFzeW5jOiB0cnVlLC8vJGhhY2tbXCIkYXN5bmNcIl0gPz8gdGhpcy4kYXN5bmMsIFxuICAgICAgICAgICAgICAgICRhcmdzOiBbdGhpcy4kZGF0YSgkaGFjayksIC4uLiRhcmdzXVxuICAgICAgICAgICAgfSlcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy9cbiAgICBkZWxldGVQcm9wZXJ0eSgkaGFjaywgLi4uJGFyZ3MpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuJGRvKCgpID0+IHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLiR3b3JrZXIuJHJlcXVlc3Qoe1xuICAgICAgICAgICAgICAgICRjbWQ6IFwiZGVsZXRlUHJvcGVydHlcIiwgXG4gICAgICAgICAgICAgICAgJGlkZW50aWZ5OiB0cnVlLCBcbiAgICAgICAgICAgICAgICAkYXN5bmM6ICRoYWNrW1wiJGFzeW5jXCJdID8/IHRoaXMuJGFzeW5jLCBcbiAgICAgICAgICAgICAgICAkYXJnczogW3RoaXMuJGRhdGEoJGhhY2spLCAuLi4kYXJnc11cbiAgICAgICAgICAgIH0pXG4gICAgICAgIH0pO1xuICAgIH1cbn07XG4iXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0EsWTs7QUFFQTtBQUNBLE9BQU9BLGlCQUFpQixJQUFJQyxPQUFPO0FBQ25DLFNBQVNDLFFBQVEsRUFBRUMsTUFBTSxFQUFFQyxLQUFLO0FBQ2hDLFNBQVNDLFFBQVEsRUFBRUMsY0FBYzs7QUFFakM7QUFDQSxlQUFlLE1BQU1DLGlCQUFpQixTQUFTRCxjQUFjLENBQUM7RUFDMUQ7RUFDQUUsT0FBTyxHQUFHLElBQUk7O0VBRWQ7RUFDQUMsTUFBTSxHQUFHLEtBQUs7O0VBRWQ7RUFDQUMsTUFBTSxHQUFHLEVBQUU7O0VBRVg7RUFDQUMsV0FBV0EsQ0FBQ0MsTUFBTSxFQUFFSCxNQUFNLEdBQUcsS0FBSyxFQUFFO0lBQ2hDLEtBQUssQ0FBQ0ksT0FBTyxDQUFDO0lBQ2QsSUFBSSxDQUFDTCxPQUFPLEdBQUdJLE1BQU07SUFDckIsSUFBSSxDQUFDSCxNQUFNLEdBQUdBLE1BQU07RUFDeEI7O0VBRUE7RUFDQUssS0FBS0EsQ0FBQ0MsRUFBRSxFQUFFLENBQUUsT0FBUUEsRUFBRSxZQUFZQyxPQUFPLEdBQUlYLFFBQVEsQ0FBQyxFQUFDLENBQUMsT0FBTyxHQUFHVSxFQUFFLEVBQUUsQ0FBQyxPQUFPLEdBQUcsRUFBQyxDQUFDLFNBQVMsR0FBRyxTQUFTLEVBQUMsRUFBQyxDQUFD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
